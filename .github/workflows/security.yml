name: ğŸ”’ Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Job 1: Dependency audit
  dependency-audit:
    name: ğŸ“¦ Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ“Š Generate audit report
        run: npm audit --json > npm-audit.json
        continue-on-error: true

      - name: ğŸ“¤ Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json
          retention-days: 30

  # Job 2: CodeQL analysis (disabled - requires GitHub Advanced Security for Organizations)
  # Uncomment if you upgrade to an organization account
  # codeql:
  #   name: ğŸ” CodeQL Analysis
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       language: ['javascript']
  #   steps:
  #     - name: ğŸ“¥ Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: ğŸ”§ Initialize CodeQL
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: ${{ matrix.language }}
  #
  #     - name: ğŸ—ï¸ Autobuild
  #       uses: github/codeql-action/autobuild@v3
  #
  #     - name: ğŸ” Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3

  # Job 3: Secret scanning
  secret-scan:
    name: ğŸ” Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Scan for secrets
        run: |
          # Check for common secret patterns
          echo "Scanning for potential secrets..."

          # Firebase service account keys
          if grep -r "private_key_id" --include="*.json" --include="*.ts" --include="*.js" .; then
            echo "âš ï¸ Warning: Possible Firebase service account key found"
          fi

          # API keys
          if grep -rE "api_key|apiKey.*=.*['\"][A-Za-z0-9]{32,}" --include="*.ts" --include="*.js" .; then
            echo "âš ï¸ Warning: Possible API key found"
          fi

          # Check .env files are not committed
          if git ls-files | grep -E "^\.env$|^\.env\.local$"; then
            echo "âŒ ERROR: .env files should not be committed!"
            exit 1
          fi

          echo "âœ… Basic secret scan completed"

  # Job 4: Firebase security rules validation
  firebase-rules:
    name: ğŸ”¥ Validate Firebase Rules
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check Firestore rules exist
        run: |
          if [ ! -f "firestore.rules" ]; then
            echo "âŒ Missing firestore.rules"
            exit 1
          fi
          echo "âœ… firestore.rules found"

      - name: ğŸ” Check Storage rules exist
        run: |
          if [ ! -f "storage.rules" ]; then
            echo "âŒ Missing storage.rules"
            exit 1
          fi
          echo "âœ… storage.rules found"

      - name: ğŸ“‹ Lint Firestore rules
        run: |
          # Basic syntax check
          if grep -q "allow read, write" firestore.rules; then
            echo "âš ï¸ Warning: Overly permissive rules detected"
          fi
          echo "âœ… Firestore rules checked"

  # Summary (CodeQL disabled - not available for personal repos)
  security-summary:
    name: âœ… Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scan, firebase-rules]
    if: always()
    steps:
      - name: âœ… All security checks passed
        if: needs.dependency-audit.result == 'success' && needs.secret-scan.result == 'success' && needs.firebase-rules.result == 'success'
        run: echo "ğŸ‰ All security checks passed!"

      - name: âš ï¸ Some checks failed
        if: needs.dependency-audit.result == 'failure' || needs.secret-scan.result == 'failure' || needs.firebase-rules.result == 'failure'
        run: |
          echo "âš ï¸ Some security checks failed. Please review."
          exit 1
