name: ğŸ§ª CI - Build, Test, Lint

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Job 1: Type checking
  typecheck:
    name: ğŸ“˜ Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run TypeScript compiler
        run: npm run type-check

  # Job 2: Linting
  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

  # Job 3: Unit tests
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Vitest
        run: npm test -- --run --reporter=json --outputFile=vitest-report.json
        continue-on-error: true

      - name: ğŸ“Š Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-report
          path: vitest-report.json
          retention-days: 7

  # Job 4: Build
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    env:
      # Dummy Firebase config for build (not used at build time)
      NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY || 'dummy-key-for-build' }}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || 'dummy.firebaseapp.com' }}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'dummy-project' }}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || 'dummy.appspot.com' }}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || '123456789' }}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID || '1:123:web:abc' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Next.js app
        run: npm run build

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next/
          retention-days: 1

  # Job 5: E2E tests (only on PRs)
  e2e:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ğŸ­ Run Playwright tests
        run: npm run test:e2e
        continue-on-error: true

      - name: ğŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # Job 6: AI Test Analysis (on failure)
  ai-triage:
    name: ğŸ¤– AI Test Analysis
    runs-on: ubuntu-latest
    needs: [test, e2e]
    if: failure()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Vitest report
        uses: actions/download-artifact@v4
        with:
          name: vitest-report
        continue-on-error: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python deps
        run: pip install anthropic requests

      - name: ğŸ¤– Analyze failures with Claude
        if: env.CLAUDE_API_KEY != ''
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 - <<'PYTHON'
          import os
          import json
          import requests
          from anthropic import Anthropic

          # Read test report
          try:
              with open('vitest-report.json', 'r') as f:
                  report = json.load(f)
          except FileNotFoundError:
              print("No test report found")
              exit(0)

          # Extract failures
          failures = []
          for test in report.get('testResults', []):
              if test.get('status') == 'failed':
                  failures.append({
                      'file': test.get('name'),
                      'error': test.get('message', 'Unknown error')
                  })

          if not failures:
              print("No failures to analyze")
              exit(0)

          # Ask Claude for analysis
          client = Anthropic(api_key=os.environ['CLAUDE_API_KEY'])
          prompt = f"""Analyze these test failures and suggest fixes:

          {json.dumps(failures, indent=2)}

          Provide:
          1. Root cause analysis
          2. Suggested fixes
          3. Prevention strategies
          """

          response = client.messages.create(
              model="claude-3-5-sonnet-20241022",
              max_tokens=1024,
              messages=[{"role": "user", "content": prompt}]
          )

          analysis = response.content[0].text

          # Post as PR comment
          pr_number = os.environ.get('PR_NUMBER')
          if pr_number:
              github_token = os.environ['GITHUB_TOKEN']
              repo = os.environ['GITHUB_REPOSITORY']
              url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"

              headers = {
                  'Authorization': f'token {github_token}',
                  'Accept': 'application/vnd.github.v3+json'
              }

              body = f"""## ğŸ¤– AI Test Analysis

          {analysis}

          <sub>Powered by Claude Code</sub>"""

              requests.post(url, headers=headers, json={'body': body})
              print("Posted analysis to PR")
          else:
              print(analysis)
          PYTHON

  # Summary job
  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [typecheck, lint, test, build]
    if: always()
    steps:
      - name: âœ… All checks passed
        if: needs.typecheck.result == 'success' && needs.lint.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success'
        run: echo "ğŸ‰ All CI checks passed!"

      - name: âŒ Some checks failed
        if: needs.typecheck.result == 'failure' || needs.lint.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "âŒ Some CI checks failed"
          exit 1
